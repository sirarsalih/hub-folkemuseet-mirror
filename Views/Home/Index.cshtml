<main class="main">
    <div id="dummy-map" class="dummy-map"></div>
    <div id="map" class="map"></div>
</main>

<script>
    var locationTimer;
    var soundTimer;
    var exitInterval = false;
    function initMap() {
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 18,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        var marker = null;
        var infoWindow = new google.maps.InfoWindow;

        if (navigator.geolocation) {
            locationTimer = setInterval(function () {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var newPoint = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    if (marker) {
                        //Marker already created - Move it
                        marker.setPosition(newPoint);
                    } else {
                        //Marker does not exist - Create it
                        marker = new google.maps.Marker({
                            position: newPoint,
                            map: map
                        });
                    }
                    //Center the map on the new position
                    map.setCenter(newPoint);

                    //Update location sounds JSON
                    updateJSON(position.coords.latitude, position.coords.longitude);
                }, function () {
                    handleLocationError(true, infoWindow, map.getCenter(), true);
                });
            }, 3000);

            soundTimer = setInterval(function () {
                //Load location sounds JSON
                new SOSV("../data/locations.json");
                if (exitInterval) clearInterval(soundTimer);
            }, 60000);

        } else {
            // Browser doesn't support Geolocation
            handleLocationError(false, infoWindow, map.getCenter(), false);
        }
    }

    function updateJSON(lat, lng)
    {
        $.ajax({
            url: '@Url.Action("UpdateJSON","Home")',
            data: { lat: lat, lng: lng }
        }).done(function() {
            console.log("JSON file updated with new position.");
        });
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos, interval) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
            'Error: Geolokasjon tjenesten feilet.' :
            'Error: Din nettleser støtter ikke geolokasjon.');
        infoWindow.open(map);
        if (interval) {
            clearInterval(locationTimer);
            exitInterval = true;
        }
    }

</script>
<!-- Load Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAL0vmWCIztR6B0zTPhFcHjEFoU2CqtVrw&callback=initMap" async defer></script>